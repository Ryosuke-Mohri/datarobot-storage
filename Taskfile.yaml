---
# https://taskfile.dev
version: "3"

dotenv: [".env"]

includes:
  agent:
    taskfile: ./agent_retrieval_agent/Taskfile.yml
    dir: ./agent_retrieval_agent
  core:
    taskfile: ./core/Taskfile.yaml
    dir: ./core
  frontend:
    taskfile: ./frontend_web/Taskfile.yaml
    dir: ./frontend_web
  web:
    taskfile: ./web/Taskfile.yaml
    dir: ./web
  infra:
    taskfile: ./infra/Taskfile.yaml
    dir: ./infra

tasks:
  install-all:
    desc: "ğŸ“¦ Install all dependencies for all subprojects that support it"
    deps:
      - agent:install
      - frontend:install
      - web:install
      - infra:install

  lint-all:
    desc: "ğŸ§¹ Lint all subprojects that support linting"
    deps:
      - core:lint
      - agent:lint
      - frontend:lint
      - infra:lint
      - web:lint

  test-all:
    desc: "ğŸ§ª Test all subprojects that support testing"
    deps:
      - web:test
      - frontend:test
      - agent:test
      - core:test

  dev-all:
    desc: "ğŸš€ Run agent, backend (web), and frontend together"
    cmds:
      - |
        task web:dev-agent &
        sleep 5
        task agent:dev &
        sleep 3
        task frontend:dev &
        sleep 8
        echo "âœ… All servers started!"
        if [[ -n "$NOTEBOOK_ID" ]]; then
          prefix="${DATAROBOT_API_ENDPOINT//api\/v2/}notebook-sessions/$NOTEBOOK_ID/ports/"
        else
          prefix="http://localhost:"
        fi
        echo "ğŸ”— Backend: ${prefix}8080"
        echo "ğŸ”— Frontend: ${prefix}5173"
        echo "ğŸ”— Agent: ${prefix}8842"
        wait

  deploy:
    desc: "ğŸš€ Deploy the infrastructure"
    cmds:
      - task infra:deploy

  build-exec-env:web:
    desc: "ğŸ³ Build pre-bundled web app execution environment for air-gapped deployment"
    dir: ./execution_environments/web_app
    cmds:
      - ./build-execution-environment.sh

  build-exec-env:agent:
    desc: "ğŸ³ Build pre-bundled agent execution environment for air-gapped deployment"
    cmds:
      - task: agent:build-docker
      - mkdir -p execution_environments/artifacts
      - cp agent_retrieval_agent/docker_context.tar.gz execution_environments/artifacts/talk-to-my-docs-agent-execution-environment.tar.gz
      - echo "Artifact saved to execution_environments/artifacts/talk-to-my-docs-agent-execution-environment.tar.gz"

  build-exec-env:all:
    desc: "ğŸ³ Build all pre-bundled execution environments for air-gapped deployment"
    deps:
      - build-exec-env:web
      - build-exec-env:agent
